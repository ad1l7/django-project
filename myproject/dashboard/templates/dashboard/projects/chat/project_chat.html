{% extends 'dashboard/projects/base/project_base.html' %}
{% load static %}
{% load custom_filters %}

{% block content %}
<style>
:root {
  --primary: #4361ee;
  --primary-dark: #3a56d4;
  --secondary: #4cc9f0;
  --success: #06d6a0;
  --light-gray: #e9ecef;
  --light: #f8f9fa;
  --dark: #212529;
  --transition: all 0.3s ease;
  --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  --shadow-hover: 0 8px 20px rgba(0, 0, 0, 0.12);
}

/* –ß–∞—Ç */
.chat-container {
  background: white;
  border-radius: 12px;
  box-shadow: var(--shadow);
  overflow: hidden;
  display: flex;
  flex-direction: column;
  height: 500px;
}

.chat-header {
  padding: 1.5rem;
  border-bottom: 1px solid var(--light-gray);
  background: var(--light);
}

.chat-messages {
  flex: 1;
  padding: 1.5rem;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.message {
  max-width: 75%;
  padding: 1rem;
  border-radius: 12px;
  position: relative;
}

.message-sent {
  background: linear-gradient(120deg, var(--primary), var(--secondary));
  color: white;
  align-self: flex-end;
  border-bottom-right-radius: 0;
}

.message-received {
  background: var(--light);
  align-self: flex-start;
  border-bottom-left-radius: 0;
}

.message-sender {
  font-weight: 600;
  margin-bottom: 5px;
}

.message-time {
  font-size: 0.75rem;
  opacity: 0.7;
  text-align: right;
  margin-top: 5px;
}

.chat-input {
  padding: 1.5rem;
  border-top: 1px solid var(--light-gray);
  background: white;
  display: flex;
  gap: 0.5rem;
}

.chat-input input {
  flex: 1;
  padding: 0.75rem 1rem;
  border: 1px solid var(--light-gray);
  border-radius: 8px;
  transition: var(--transition);
}

.chat-input input:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
  outline: none;
}

.chat-input button {
  background: var(--primary);
  color: white;
  border: none;
  border-radius: 8px;
  padding: 0.75rem 1.5rem;
  cursor: pointer;
  transition: var(--transition);
  display: flex;
  align-items: center;
  justify-content: center;
}

.chat-input button:hover {
  background: var(--primary-dark);
}
</style>
<div class="section">
  <h3 class="section-title"><i class="fas fa-comments"></i> –ß–∞—Ç –ø—Ä–æ–µ–∫—Ç–∞</h3>
  
  <div class="chat-container">
<div class="chat-header d-flex align-items-center justify-content-between">
  <h5>–û–±—â–∏–π —á–∞—Ç –ø—Ä–æ–µ–∫—Ç–∞: {{ project.title }}</h5>
  {% if request.user.role in 'ADMIN DIRECTOR' %}
    <form method="post">
      {% csrf_token %}
      <button type="submit" name="clear_chat" class="btn btn-danger btn-sm">
        <i class="fas fa-trash-alt"></i> –û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç
      </button>
    </form>
  {% endif %}
</div>

<div class="chat-messages">
  {% for msg in messages %}
    <div class="message {% if msg.sender == request.user %}message-sent{% else %}message-received{% endif %}">
      <div class="message-sender">
        {{ msg.sender.get_full_name }}{% if msg.sender == request.user %} (–í—ã){% endif %}
      </div>

      {% if msg.content %}
        <div class="message-text">{{ msg.content }}</div>
      {% endif %}

      {% if msg.attachment %}
        <div class="message-text">
          üìé <a href="{{ msg.attachment.url }}" target="_blank" download>
            –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª ({{ msg.attachment.name|cut:"chat_attachments/" }})
          </a>
        </div>
      {% endif %}

      <div class="message-time">{{ msg.timestamp|date:"Y-m-d H:i" }}</div>
    </div>
  {% empty %}
    <div class="text-center p-4">
      <i class="fas fa-comment-slash fa-2x mb-3 text-muted"></i>
      <p>–°–æ–æ–±—â–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º, –∫—Ç–æ –Ω–∞–ø–∏—à–µ—Ç!</p>
    </div>
  {% endfor %}
</div>

<form method="post" enctype="multipart/form-data" class="chat-input" id="chat-form">
  {% csrf_token %}
  <input type="text" 
         name="content" 
         class="form-control" 
         placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." 
         required>
  
  <input type="file" name="attachment" id="attachment" style="display: none;" onchange="document.getElementById('chat-form').submit();">
  <label for="attachment" class="btn btn-secondary" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª">
    <i class="fas fa-paperclip"></i>
  </label>

  <button type="submit" name="send_message" class="btn btn-primary">
    <i class="fas fa-paper-plane"></i>
  </button>
</form>
  </div>
</div>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const messagesContainer = document.querySelector('.chat-messages');
    let lastMessageCount = 0;

    function fetchMessages() {
      fetch("{% url 'dashboard:fetch_project_messages' project.id %}")
        .then(response => response.json())
        .then(data => {
          if (data.messages.length === lastMessageCount) return; // –Ω–µ—Ç –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

          // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ—è–≤–∏–ª–∏—Å—å –Ω–æ–≤—ã–µ
          lastMessageCount = data.messages.length;
          const wasAtBottom = messagesContainer.scrollHeight - messagesContainer.scrollTop <= messagesContainer.clientHeight + 50;

          messagesContainer.innerHTML = ''; // –æ—á–∏—Å—Ç–∫–∞, –Ω–æ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
          data.messages.forEach(msg => {
            const div = document.createElement('div');
            div.className = `message ${msg.is_user ? 'message-sent' : 'message-received'}`;
            let attachmentHTML = '';
            if (msg.attachment_url) {
              attachmentHTML = `
                <div class="message-text">
                  üìé <a href="${msg.attachment_url}" target="_blank" download>
                    –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª
                  </a>
                </div>`;
            }
            
            div.innerHTML = `
              <div class="message-sender">${msg.sender} ${msg.is_user ? '(–í—ã)' : ''}</div>
              ${msg.content ? `<div class="message-text">${msg.content}</div>` : ''}
              ${attachmentHTML}
              <div class="message-time">${msg.timestamp}</div>
            `;

            messagesContainer.appendChild(div);
          });

          if (wasAtBottom) {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
          }
        });
    }

    fetchMessages(); // –ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫
    setInterval(fetchMessages, 1000); // –∫–∞–∂–¥—ã–µ 1 —Å–µ–∫—É–Ω–¥–∞
  });
</script>


{% endblock %}