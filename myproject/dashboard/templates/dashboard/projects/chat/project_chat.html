{% extends 'dashboard/projects/base/project_base.html' %}
{% load static %}
{% load custom_filters %}

{% block content %}
<link rel="stylesheet" href="{% static 'dashboard/css/projects/chat/project_chat.css' %}">
<style>

</style>
<div class="section">
  <h3 class="section-title"><i class="fas fa-comments"></i> –ß–∞—Ç –ø—Ä–æ–µ–∫—Ç–∞</h3>
  
  <div class="chat-container">
<div class="chat-header d-flex align-items-center justify-content-between">
  <h5>–û–±—â–∏–π —á–∞—Ç –ø—Ä–æ–µ–∫—Ç–∞: {{ project.title }}</h5>
  {% if request.user.role in 'ADMIN DIRECTOR' %}
    <form method="post">
      {% csrf_token %}
      <button type="submit" name="clear_chat" class="btn btn-danger btn-sm">
        <i class="fas fa-trash-alt"></i> –û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç
      </button>
    </form>
  {% endif %}
</div>

<div class="chat-messages">
  {% for msg in messages %}
    <div class="message {% if msg.sender == request.user %}message-sent{% else %}message-received{% endif %}">
      <div class="message-sender">
        {{ msg.sender.get_full_name }}{% if msg.sender == request.user %} (–í—ã){% endif %}
      </div>

      {% if msg.content %}
        <div class="message-text">{{ msg.content }}</div>
      {% endif %}

      {% if msg.attachment %}
        <div class="message-text">
          üìé <a href="{{ msg.attachment.url }}" target="_blank" download>
            –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª ({{ msg.attachment.name|cut:"chat_attachments/" }})
          </a>
        </div>
      {% endif %}

      <div class="message-time">{{ msg.timestamp|date:"Y-m-d H:i" }}</div>
    </div>
  {% empty %}
    <div class="text-center p-4">
      <i class="fas fa-comment-slash fa-2x mb-3 text-muted"></i>
      <p>–°–æ–æ–±—â–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º, –∫—Ç–æ –Ω–∞–ø–∏—à–µ—Ç!</p>
    </div>
  {% endfor %}
</div>

<form method="post" enctype="multipart/form-data" class="chat-input" id="chat-form">
  {% csrf_token %}
  <input type="text" 
         name="content" 
         class="form-control" 
         placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." 
         required>
  
  <input type="file" name="attachment" id="attachment" style="display: none;" onchange="document.getElementById('chat-form').submit();">
  <label for="attachment" class="btn btn-secondary" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª">
    <i class="fas fa-paperclip"></i>
  </label>

  <button type="submit" name="send_message" class="btn btn-primary">
    <i class="fas fa-paper-plane"></i>
  </button>
</form>
  </div>
</div>
<script src="{% static 'dashboard/js/projects/chat/project_chat.js' %}"></script>


{% endblock %}